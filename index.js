// Generated by CoffeeScript 1.7.0
(function() {
  var Chest, ChestDialog, Inventory, InventoryWindow, ItemPile, ModalDialog,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  ModalDialog = require('voxel-modal-dialog');

  Inventory = require('inventory');

  InventoryWindow = require('inventory-window');

  ItemPile = require('itempile');

  module.exports = function(game, opts) {
    return new Chest(game, opts);
  };

  module.exports.pluginInfo = {
    loadAfter: ['voxel-blockdata', 'voxel-registry', 'voxel-recipes', 'voxel-carry']
  };

  Chest = (function() {
    function Chest(game, opts) {
      var _ref, _ref1, _ref2, _ref3;
      this.game = game;
      this.playerInventory = (function() {
        var _ref1, _ref2, _ref3;
        if ((_ref = (_ref1 = (_ref2 = game.plugins) != null ? (_ref3 = _ref2.get('voxel-carry')) != null ? _ref3.inventory : void 0 : void 0) != null ? _ref1 : opts.playerInventory) != null) {
          return _ref;
        } else {
          throw new Error('voxel-chest requires "voxel-carry" plugin or "playerInventory" set to inventory instance');
        }
      })();
      this.registry = (_ref1 = game.plugins) != null ? _ref1.get('voxel-registry') : void 0;
      this.recipes = (_ref2 = game.plugins) != null ? _ref2.get('voxel-recipes') : void 0;
      this.blockdata = (_ref3 = game.plugins) != null ? _ref3.get('voxel-blockdata') : void 0;
      if (opts.registerBlock == null) {
        opts.registerBlock = this.registry != null;
      }
      if (opts.registerRecipe == null) {
        opts.registerRecipe = this.recipes != null;
      }
      if (this.game.isClient) {
        this.chestDialog = new ChestDialog(game, this.playerInventory, this.registry, this.blockdata);
      }
      this.opts = opts;
      this.enable();
    }

    Chest.prototype.enable = function() {
      if (this.opts.registerBlock) {
        this.registry.registerBlock('chest', {
          texture: ['door_wood_lower', 'piston_top_normal', 'bookshelf'],
          onInteract: (function(_this) {
            return function(target) {
              _this.chestDialog.open(target);
              return true;
            };
          })(this)
        });
      }
      if (this.opts.registerRecipe) {
        return this.recipes.registerPositional([['wood.plank', 'wood.plank', 'wood.plank'], ['wood.plank', void 0, 'wood.plank'], ['wood.plank', 'wood.plank', 'wood.plank']], new ItemPile('chest', 1));
      }
    };

    Chest.prototype.disable = function() {};

    return Chest;

  })();

  ChestDialog = (function(_super) {
    __extends(ChestDialog, _super);

    function ChestDialog(game, playerInventory, registry, blockdata) {
      var chestCont, contents;
      this.game = game;
      this.playerInventory = playerInventory;
      this.registry = registry;
      this.blockdata = blockdata;
      this.playerIW = new InventoryWindow({
        width: 10,
        registry: this.registry,
        inventory: this.playerInventory
      });
      this.chestInventory = new Inventory(10, 3);
      this.chestInventory.on('changed', (function(_this) {
        return function() {
          return _this.updateBlockdata();
        };
      })(this));
      this.chestIW = new InventoryWindow({
        inventory: this.chestInventory,
        registry: this.registry
      });
      this.chestIW.linkedInventory = this.playerInventory;
      this.playerIW.linkedInventory = this.chestInventory;
      if (typeof document !== "undefined" && document !== null) {
        chestCont = this.chestIW.createContainer();
        contents = [];
        contents.push(chestCont);
        contents.push(document.createElement('br'));
        contents.push(this.playerIW.createContainer());
      }
      ChestDialog.__super__.constructor.call(this, game, {
        contents: contents
      });
    }

    ChestDialog.prototype.loadBlockdata = function(x, y, z) {
      var bd, i, itemPile, newInventory, _i, _len, _ref;
      if (this.blockdata == null) {
        console.log('voxel-blockdata not loaded, voxel-chest persistence disabled');
        return;
      }
      bd = this.blockdata.get(x, y, z);
      console.log('activeBlockdata=', JSON.stringify(bd));
      if (bd != null) {
        console.log('load existing at ', x, y, z);
        newInventory = Inventory.fromString(bd.inventory);
        console.log('newInventory=' + JSON.stringify(newInventory));
        _ref = newInventory.array;
        for (i = _i = 0, _len = _ref.length; _i < _len; i = ++_i) {
          itemPile = _ref[i];
          console.log('load chest', i, itemPile);
          this.chestInventory.set(i, itemPile);
        }
      } else {
        console.log('new empty inventory at ', x, y, z);
        bd = {
          inventory: this.chestInventory.toString()
        };
        this.blockdata.set(x, y, z, bd);
      }
      this.activeBlockdata = bd;
      return console.log('activeBlockdata 2=', JSON.stringify(this.activeBlockdata));
    };

    ChestDialog.prototype.open = function(target) {
      var x, y, z, _ref;
      this.chestInventory.clear();
      _ref = target.voxel, x = _ref[0], y = _ref[1], z = _ref[2];
      this.loadBlockdata(x, y, z);
      return ChestDialog.__super__.open.call(this);
    };

    ChestDialog.prototype.updateBlockdata = function() {
      console.log('update with activeBlockdata=', JSON.stringify(this.activeBlockdata));
      if (this.activeBlockdata == null) {
        return;
      }
      console.log('chestInventory=', this.chestInventory.toString());
      return this.activeBlockdata.inventory = this.chestInventory.toString();
    };

    ChestDialog.prototype.close = function() {
      delete this.activeBlockdata;
      return ChestDialog.__super__.close.call(this);
    };

    return ChestDialog;

  })(ModalDialog);

}).call(this);
